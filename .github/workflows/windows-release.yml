name: Windows Build (push) + Release Build (tag)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  release:
    types: [published]

permissions:
  contents: write

env:
  BIN_NAME: BOM

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      # -----------------------------
      # PUSH main: cargo build (debug)
      # -----------------------------
      - name: Cargo build (debug)
        if: github.ref_type == 'branch'
        run: cargo build --locked

      - name: Prepare debug exe artifact
        if: github.ref_type == 'branch'
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p dist
          cp "target/debug/${BIN_NAME}.exe" "dist/${BIN_NAME}-windows-debug.exe"

      - name: Upload debug exe artifact
        if: github.ref_type == 'branch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-windows-debug-${{ github.run_number }}
          path: dist/${{ env.BIN_NAME }}-windows-debug.exe

      # ------------------------------------
      # TAG / RELEASE: cargo build --release
      # ------------------------------------
      - name: Cargo build (release)
        if: github.ref_type == 'tag' || github.event_name == 'release'
        run: cargo build --release --locked

      - name: Prepare release exe artifact
        if: github.ref_type == 'tag' || github.event_name == 'release'
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p dist
          cp "target/release/${BIN_NAME}.exe" "dist/${BIN_NAME}-windows-release.exe"

      - name: Upload release exe artifact
        if: github.ref_type == 'tag' || github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-windows-release-${{ github.ref_name }}
          path: dist/${{ env.BIN_NAME }}-windows-release.exe

      - name: Upload to GitHub Release assets
        if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: dist/${{ env.BIN_NAME }}-windows-release.exe
          overwrite_files: true
